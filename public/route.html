<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>路线规划 Demo</title>
</head>
<script charset="utf-8"
        src="https://map.qq.com/api/gljs?v=1.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77"></script>
<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
<style>
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    #mapContainer {
        width: 100%;
        height: 100%;
    }
</style>

<body onload="initMap()">
<div id="mapContainer"></div>
</body>

</html>
<script>
    function processData(data) {
        return data.map(it => new TMap.LatLng(it.lat, it.lng)).map((it,i) => {
            return {
                position: it,
                id: 'marker',
                "properties": {
                    "title": `marker${i}`
                }
            };
        });
    }

    let map;

    function initMap() {
        $.get("/locations.json", (data) => {
            let pd = processData(data);
            console.log(pd);
            //初始化地图
            map = new TMap.Map('mapContainer', {
                center: pd[0].position,//地图显示中心点
                zoom: 16	//缩放级别
            });
            display_points(pd);
        })
        $.get("/route.json", (data) => cb(data))
    }

    function display_points(data) {
        new TMap.MultiMarker({
            map: map,
            styles: {
                // 点标记样式
                marker: new TMap.MarkerStyle({
                    width: 20, // 样式宽
                    height: 30, // 样式高
                    anchor: {x: 10, y: 30}, // 描点位置
                }),
            },
            geometries: data,
        });
    }

    //定义请求回调函数，在此拿到计算得到的路线，并进行绘制
    function cb(ret) {
        const pls = [];
        for (let polyline of ret) {
            const coords = polyline, pl = [];
            //坐标解压（返回的点串坐标，通过前向差分进行压缩）
            const kr = 1000000;
            for (let i = 2; i < coords.length; i++) {
                coords[i] = Number(coords[i - 2]) + Number(coords[i]) / kr;
            }
            //将解压后的坐标放入点串数组pl中
            for (let i = 0; i < coords.length; i += 2) {
                pl.push(new TMap.LatLng(coords[i], coords[i + 1]));
            }
            pls.push(pl)
        }

        display_polyline(pls)//显示路线
    }

    function display_polyline(pls) {
        //折线数据定义
        const geometries = pls.map((pl, i) => {
            return {
                'id': `pl_${i}`,//折线唯一标识，删除时使用
                'styleId': 'style_blue',//绑定样式名
                'paths': pl
            };
        })
        //创建 MultiPolyline显示折线
        new TMap.MultiPolyline({
            id: 'polyline-layer', //图层唯一标识
            map: map,//绘制到目标地图
            //折线样式定义
            styles: {
                'style_blue': new TMap.PolylineStyle({
                    'color': '#3777FF', //线填充色
                    'width': 8, //折线宽度
                    'borderWidth': 5, //边线宽度
                    'borderColor': '#FFF', //边线颜色
                    'lineCap': 'round', //线端头方式
                })
            },
            geometries
        });
    }

</script>